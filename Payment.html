<!DOCTYPE html>
<html>
<head>
  <title>Payment Required</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: Arial; padding: 20px; background: #f0f0f0; }
    .container { background: #fff; padding: 20px; max-width: 600px; margin: auto; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    textarea { width: 100%; height: 100px; margin: 10px 0; }
    button { padding: 10px 20px; background: green; color: #fff; border: none; cursor: pointer; width: 100%; }
    .message { margin-top: 10px; font-weight: bold; }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <div class="container">
    <h2 class="mb-3">Complete Your Payment</h2>
    <p>Please pay <strong>Ksh 35</strong> to Till Number <strong>4585402</strong>.</p>
    <p>After payment, copy and paste the M-Pesa confirmation message below:</p>

    <textarea id="mpesaMessage" placeholder="e.g., QHI2CQM1YZ Confirmed. Ksh35.00 paid to Emanuel Kipkirui Bett. on 18/5/25 at 8:42 AM."></textarea>
    <button onclick="submitMessage()">Submit for Verification</button>

    <p class="message" id="statusMsg"></p>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDukaltO2J2G-R-HSR7J6CL1yo0_TUja7o",
      authDomain: "training-b61c4.firebaseapp.com",
      projectId: "training-b61c4",
      storageBucket: "training-b61c4.appspot.com",
      messagingSenderId: "318739852647",
      appId: "1:318739852647:web:62b5d6e44417f0c66a53c2",
      measurementId: "G-WFKC7D219M",
      databaseURL: "https://training-b61c4-default-rtdb.firebaseio.com/"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Simple regex to preliminarily check message format (optional)
    const mpesaRegex = /^[A-Z0-9]{10}\s+Confirmed\. Ksh35(\.00)? paid to Emanuel Kipkirui Bett\./i;

    function submitMessage() {
      const msg = document.getElementById("mpesaMessage").value.trim();
      const status = document.getElementById("statusMsg");

      if (!msg) {
        status.textContent = "❌ Please paste the M-Pesa confirmation message.";
        status.style.color = "red";
        return;
      }

      // Optional: alert user if format is unexpected, but still allow submission for admin to verify
      if (!mpesaRegex.test(msg)) {
        status.textContent = "⚠️ Message format looks unusual but will still be submitted for admin verification.";
        status.style.color = "orange";
      } else {
        status.textContent = "⏳ Message format looks good. Submitting for admin verification...";
        status.style.color = "blue";
      }

      // Push to Firebase with verified: false
      const newRef = db.ref("payments").push();
      const key = newRef.key;

      newRef.set({
        message: msg,
        verified: false,
        timestamp: new Date().toISOString()
      }).then(() => {
        status.textContent = "✅ Submitted. Waiting for admin verification...";
        status.style.color = "green";
        document.getElementById("mpesaMessage").value = "";

        // Listen for admin verification
        db.ref("payments/" + key + "/verified").on("value", snapshot => {
          if (snapshot.val() === true) {
            localStorage.removeItem("startTime");
            status.textContent = "✅ Payment verified by admin! Redirecting...";
            status.style.color = "green";
            setTimeout(() => {
              window.location.href = "page1.html";
            }, 2000);
          }
        });
      }).catch(err => {
        status.textContent = "❌ Submission failed: " + err.message;
        status.style.color = "red";
      });
    }
  </script>
</body>
</html>